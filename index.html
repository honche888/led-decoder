<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>LED Rolling Shutter Decoder (å‡ç´šç‰ˆå¯è§£ç¢¼)</title>
  <style>
    body { background:#0d1117; color:#e6edf3; font-family:Arial; text-align:center; padding:20px; }
    button { padding:10px 20px; font-size:16px; cursor:pointer; margin:10px; border-radius:5px; }
    #video { width:90%; max-width:400px; margin-top:15px; }
    #result, #bitStream { background:#161b22; padding:12px; border-radius:6px; margin:10px auto; width:90%; max-width:500px; }
  </style>
</head>

<body>
  <h2>ğŸ“¸ LED Rolling Shutter è§£ç¢¼å™¨ï¼ˆå¯åµæ¸¬ HEADER + PAYLOADï¼‰</h2>

  <button onclick="startCamera()">å•Ÿå‹•ç›¸æ©Ÿ</button>
  <button onclick="stopCamera()">åœæ­¢</button>

  <br>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <h3>ğŸ“¶ Bit Streamï¼ˆå³æ™‚äºŒå€¼åŒ–è³‡æ–™ï¼‰</h3>
  <div id="bitStream">ç­‰å¾…ä¸­â€¦</div>

  <h3>ğŸ§¾ å”å®šè§£ç¢¼çµæœï¼ˆHEADER + PAYLOADï¼‰</h3>
  <div id="result">ç­‰å¾…æœ‰æ•ˆ frameâ€¦</div>

<script>
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let ctx = canvas.getContext("2d");
  let streaming = false;
  let receivedBits = [];

  const HEADER = "10101011";
  let foundHeader = false;
  let bitBuffer = "";

  async function startCamera() {
    try {
      let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      streaming = true;
      analyzeFrame();
    } catch (err) {
      alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err);
    }
  }

  function stopCamera() {
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
    }
    streaming = false;
  }

  function analyzeFrame() {
    if (!streaming) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    let frame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

    // ğŸ” æ“·å–ç•«é¢ä¸­å¤®å€åŸŸå¹³å‡äº®åº¦
    let brightnessSum = 0, count = 0;
    for (let y = canvas.height*0.4; y < canvas.height*0.6; y++) {
      for (let x = canvas.width*0.4; x < canvas.width*0.6; x++) {
        let idx = (y * canvas.width + x) * 4;
        let Y = 0.299 * frame[idx] + 0.587 * frame[idx+1] + 0.114 * frame[idx+2];
        brightnessSum++;
        count++;
      }
    }

    let avgBrightness = brightnessSum / count;

    // ğŸŸ¢ äºŒå€¼åŒ–ï¼šå°‡äº®åº¦ â†’ bit
    let bit = avgBrightness > 130 ? "1" : "0";
    bitBuffer += bit;

    // é¡¯ç¤ºå³æ™‚ bit stream
    document.getElementById("bitStream").innerText = bitBuffer.slice(-80);

    // ğŸ” å°‹æ‰¾ HEADER
    if (!foundHeader && bitBuffer.includes(HEADER)) {
      foundHeader = true;
      let startIndex = bitBuffer.indexOf(HEADER) + HEADER.length;
      let payloadBits = bitBuffer.slice(startIndex, startIndex + 40); // å–å¾Œé¢ 40 bits

      if (payloadBits.length >= 8) {
        let decodedText = bitsToText(payloadBits);
        document.getElementById("result").innerText = "ğŸ“© è§£ç¢¼æˆåŠŸï¼š " + decodedText;
      }
    }

    requestAnimationFrame(analyzeFrame);
  }

  function bitsToText(bits) {
    let text = "";
    for (let i = 0; i < bits.length; i += 8) {
      let charCode = parseInt(bits.slice(i, i+8), 2);
      text += String.fromCharCode(charCode);
    }
    return text;
  }
</script>
</body>
</html>
